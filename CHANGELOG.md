# Changelog

All notable changes to this project will be documented in this file.

## [Unreleased]

### Fixed
- **CRITICAL**: Fixed storage table RLS policies and corrected storage usage trigger function
  - Re-enabled Row Level Security on `storage_quotas`, `storage_usage`, and `file_metadata` tables
  - Added proper RLS policies for tier-based quota access (users can only see their own tier's quota)
  - Added comprehensive RLS policies for admin/team member access to storage usage and file metadata
  - Corrected `update_storage_usage_trigger` function to properly handle file count updates during UPDATE operations
  - Fixed file count calculation to only change on INSERT/DELETE, not on file size/type updates
  - Added `WITH CHECK` clauses to all `FOR ALL` policies for enhanced security
  - Populated `storage_quotas` table with tier-based limits (Starter: 2GB, Professional: 5GB, Enterprise: 50GB)
  - This resolves the "storage_quota table rows not getting populated" issue and secures storage-related data access

### Technical Details
- Database migration: `create_storage_rls_policies.sql` implements comprehensive storage security
- Corrected trigger function logic to prevent incorrect file count modifications during file updates
- Added tier-based quota access policy that restricts users to seeing only their subscription tier's limits
- Enhanced file metadata access policies with proper `WITH CHECK` clauses for INSERT/UPDATE operations
- Used `ON CONFLICT (tier) DO UPDATE` for safe quota data population without duplicate key errors
- All SQL avoids problematic `ALTER COLUMN ... GENERATED BY DEFAULT AS IDENTITY` and `OWNER TO` syntax

### Benefits
- Secures storage-related data with proper Row Level Security enforcement
- Prevents unauthorized access to other companies' storage usage and file metadata
- Ensures accurate storage usage tracking with corrected trigger logic
- Provides tier-based quota visibility for subscription management
- Maintains data integrity while enabling proper access control
- Resolves storage quota population issues with safe upsert operations

### Fixed
- **CRITICAL**: Fixed Stripe Edge Functions event loop errors by downgrading to compatible library version
  - Downgraded Stripe library from v16.0.0 to v13.17.0 across all Edge Functions to resolve `Deno.core.runMicrotasks()` errors
  - Changed target from `esnext` to `deno` for better Deno runtime compatibility
  - This resolves the "SubtleCryptoProvider cannot be used in a synchronous context" errors in webhook processing
  - Combined with existing `httpClient: Stripe.createFetchHttpClient()` configuration for optimal Deno compatibility
  - Webhooks and checkout sessions now process correctly without runtime errors

### Technical Details
- Modified `deno.json` files for all Stripe-related Edge Functions to use Stripe v13.17.0
- Updated target parameter from `esnext` to `deno` for improved compatibility
- Maintains all existing webhook event handling and subscription processing functionality
- Version 13.17.0 has proven stable in Deno environments while still supporting required Stripe API features

### Benefits
- Eliminates Edge Function crashes during webhook and checkout processing
- Ensures reliable Stripe integration with proper Deno runtime compatibility
- Maintains all existing subscription and payment processing functionality
- Improves system reliability and reduces payment processing errors

### Fixed
- **CRITICAL**: Fixed Stripe webhook signature verification for Deno environment
  - Added support for `constructEventAsync` method when available in newer Stripe versions
  - Implemented manual signature verification fallback using Deno's `crypto.subtle` API for compatibility
  - This resolves "SubtleCryptoProvider cannot be used in a synchronous context" errors in webhook processing
  - Webhooks now process correctly without `Deno.core.runMicrotasks()` or signature verification errors
  - Maintains backward compatibility with existing webhook processing logic

### Technical Details
- Enhanced `supabase/functions/stripe-webhook/index.ts` with dual signature verification approach
- Uses `constructEventAsync` when available, falls back to manual HMAC-SHA256 verification
- Leverages Deno's native `crypto.subtle` API for cryptographic operations
- All changes maintain existing webhook event handling functionality

### Benefits
- Eliminates webhook signature verification failures in Deno runtime
- Ensures reliable Stripe integration with proper async crypto operations
- Maintains all existing subscription and payment processing functionality
- Improves system reliability and reduces webhook processing errors

### Added
- **Database Primary Keys**: Added explicit primary key constraints to Stripe tables for improved data integrity and manageability.
  - Added `PRIMARY KEY (id)` to `public.stripe_subscriptions` table.
  - Added `PRIMARY KEY (id)` to `public.stripe_orders` table.
  - This resolves issues with deleting records and ensures unique identification for each entry.


## Core Application Functions

### User Management System
1. **User Role Hierarchy**: The system supports different user types with distinct access levels:
   - **Owners**: Full administrative access, can manage company settings, billing, and all users
   - **Admins**: Administrative access to manage properties, templates, and inspections
   - **Members**: Invited users with limited access and specific role-based permissions

2. **Onboarding Flow**: Structured user onboarding process ensures proper payment setup:
   - User registers and receives email confirmation
   - After email confirmation, user is redirected to start-trial page
   - User must enter card details and complete payment setup
   - Dashboard access is granted only after successful payment method authorization
   - This ensures all trial users have valid payment methods for seamless conversion

3. **Trial and Billing System**: Fair and transparent billing model:
   - 14-day free trial period with full feature access
   - Payment method is authorized (not charged) during trial signup
   - Clients are only charged after the 14-day trial period expires
   - Users can cancel anytime before trial ends to avoid charges
   - Automatic conversion to paid subscription if not cancelled

### Technical Implementation
- Row Level Security (RLS) policies enforce role-based access control
- Comprehensive user session validation and authentication flows
- Stripe integration with proper trial period handling and webhook processing
- Automated user profile and company record creation via database triggers

## [Unreleased]

### Fixed
- **CRITICAL**: Fixed Stripe Edge Functions event loop errors preventing webhook and checkout processing
  - Added `httpClient: Stripe.createFetchHttpClient()` to Stripe initialization in both webhook and checkout Edge Functions
  - Changed `stripe.webhooks.constructEventAsync()` to synchronous `stripe.webhooks.constructEvent()` method
  - This resolves `Deno.core.runMicrotasks()` and event loop errors by using Deno's native fetch API instead of Node.js HTTP modules
  - Stripe webhooks and checkout sessions now process correctly without runtime errors

### Technical Details
- Modified `supabase/functions/stripe-webhook/index.ts` to use Deno-compatible Stripe HTTP client
- Modified `supabase/functions/stripe-checkout/index.ts` to use Deno-compatible Stripe HTTP client
- Replaced non-existent `constructEventAsync` with proper synchronous `constructEvent` method
- All changes maintain backward compatibility with existing webhook processing logic

### Benefits
- Eliminates Edge Function crashes during webhook and checkout processing
- Ensures reliable Stripe integration with proper Deno runtime compatibility
- Maintains all existing subscription and payment processing functionality
- Improves system reliability and reduces payment processing errors

### Fixed
- **CRITICAL**: Fixed Stripe Edge Functions compatibility issues preventing checkout and webhook processing
  - Updated MinIO library import in `storage-api` Edge Function to use `esm.sh` with `?target=esnext` for better Deno compatibility
  - This should resolve the remaining `Deno.core.runMicrotasks()` errors that were causing Edge Function crashes
  - Enhanced PKCE authentication flow in `AuthCallbackPage` with explicit `code_verifier` validation and better error handling
  - Added comprehensive debugging to identify when PKCE state is missing from localStorage

### Technical Details
- Modified `storage-api/deno.json` to use compatible MinIO library version with proper Deno target
- Enhanced authentication callback page with more robust PKCE flow validation and user-friendly error messages
- Improved error messaging for expired confirmation links and session state issues
- All changes maintain backward compatibility with existing authentication flows

### Benefits
- Eliminates Edge Function crashes during file upload operations
- Resolves authentication timeout issues during email confirmation flow
- Provides clearer error messages for authentication failures with expired confirmation links
- Maintains data integrity while improving system reliability
- Better user experience with specific guidance when authentication fails

### Fixed
- **CRITICAL**: Fixed Stripe Edge Functions compatibility issues preventing checkout and webhook processing
  - Updated MinIO library import in `storage-api` Edge Function to use `esm.sh` with `?target=esnext` for better Deno compatibility
  - This should resolve the remaining `Deno.core.runMicrotasks()` errors that were causing Edge Function crashes
  - Enhanced PKCE authentication flow in `AuthCallbackPage` with explicit `code_verifier` validation and better error handling
  - Added database migration to establish primary keys on Stripe tables, enabling proper row deletion operations in Supabase dashboard

### Technical Details
- Modified `storage-api/deno.json` to use compatible MinIO library version with proper Deno target
- Enhanced authentication callback page with more robust PKCE flow validation and user-friendly error messages
- Database migration `add_stripe_table_primary_keys.sql` recreates Stripe tables with proper `SERIAL PRIMARY KEY` constraints
- All changes maintain backward compatibility with existing data and subscription flows
- Uses table recreation approach instead of problematic `ALTER COLUMN` syntax for PostgreSQL compatibility

### Benefits
- Eliminates Edge Function crashes during file upload operations
- Resolves authentication timeout issues during email confirmation flow
- Enables proper database management and cleanup operations in Supabase dashboard
- Provides clearer error messages for authentication failures with expired confirmation links
- Maintains data integrity while improving system reliability
- Allows deletion of test records from Stripe tables for easier development workflow

### Fixed
- **CRITICAL**: Fixed Stripe Edge Functions compatibility issues preventing checkout and webhook processing
  - Downgraded Stripe library from v16.0.0 to v13.17.0 across all Edge Functions to resolve `Deno.core.runMicrotasks()` errors
  - Updated MinIO library import in `storage-api` Edge Function to use `esm.sh` with `?target=esnext` for better Deno compatibility
  - Fixed `ReferenceError: paymentMethodBrand is not defined` in webhook by properly initializing variables at case block start
  - Replaced complex insert/fallback logic with proper `upsert` operations using `onConflict: "customer_id"` to eliminate duplicate key errors
  - Enhanced PKCE authentication flow in `AuthCallbackPage` with explicit `code_verifier` validation and better error handling
  - Added database migration to establish primary keys on Stripe tables, enabling proper row deletion operations in Supabase dashboard

### Technical Details
- Modified `deno.json` files for all Stripe-related Edge Functions to use compatible library versions
- Enhanced webhook error handling and logging for better debugging of subscription lifecycle events
- Improved authentication callback page with more robust PKCE flow validation and user-friendly error messages
- Database migration `add_stripe_table_primary_keys.sql` adds primary key constraints to `stripe_customers`, `stripe_orders`, and `stripe_subscriptions` tables
- All changes maintain backward compatibility with existing data and subscription flows

### Benefits
- Eliminates Edge Function crashes during checkout and webhook processing
- Resolves authentication timeout issues during email confirmation flow
- Prevents duplicate subscription records and database constraint violations
- Enables proper database management and cleanup operations
- Provides clearer error messages for authentication failures
- Maintains data integrity while improving system reliability

### Fixed
- **CRITICAL**: Fixed Stripe Edge Functions compatibility issues preventing checkout and webhook processing
  - Downgraded Stripe library from v16.0.0 to v13.17.0 across all Edge Functions to resolve `Deno.core.runMicrotasks()` errors
  - Updated MinIO library import in `storage-api` Edge Function to use `esm.sh` with `?target=esnext` for better Deno compatibility
  - Fixed `ReferenceError: paymentMethodBrand is not defined` in webhook by properly initializing variables at case block start
  - Replaced complex insert/fallback logic with proper `upsert` operations using `onConflict: "customer_id"` to eliminate duplicate key errors
  - Enhanced PKCE authentication flow in `AuthCallbackPage` with explicit `code_verifier` validation and better error handling
  - Added database migration to establish primary keys on Stripe tables, enabling proper row deletion operations in Supabase dashboard

### Technical Details
- Modified `deno.json` files for all Stripe-related Edge Functions to use compatible library versions
- Enhanced webhook error handling and logging for better debugging of subscription lifecycle events
- Improved authentication callback page with more robust PKCE flow validation and user-friendly error messages
- Database migration `fix_stripe_table_primary_keys.sql` adds primary key constraints to `stripe_customers`, `stripe_orders`, and `stripe_subscriptions` tables
- All changes maintain backward compatibility with existing data and subscription flows

### Benefits
- Eliminates Edge Function crashes during checkout and webhook processing
- Resolves authentication timeout issues during email confirmation flow
- Prevents duplicate subscription records and database constraint violations
- Enables proper database management and cleanup operations
- Provides clearer error messages for authentication failures
- Maintains data integrity while improving system reliability

### Fixed
- **CRITICAL**: Fixed Stripe Edge Functions compatibility issues preventing checkout and webhook processing
  - Downgraded Stripe library from v16.0.0 to v13.17.0 across all Edge Functions to resolve `Deno.core.runMicrotasks()` errors
  - Updated MinIO library import in `storage-api` Edge Function to use `esm.sh` with `?target=esnext` for better Deno compatibility
  - Fixed `ReferenceError: paymentMethodBrand is not defined` in webhook by properly initializing variables at case block start
  - Replaced complex insert/fallback logic with proper `upsert` operations using `onConflict: "customer_id"` to eliminate duplicate key errors
  - Enhanced PKCE authentication flow in `AuthCallbackPage` with explicit `code_verifier` validation and better error handling
  - Added database migration to establish primary keys on Stripe tables, enabling proper row deletion operations in Supabase dashboard

### Technical Details
- Modified `deno.json` files for all Stripe-related Edge Functions to use compatible library versions
- Enhanced webhook error handling and logging for better debugging of subscription lifecycle events
- Improved authentication callback page with more robust PKCE flow validation and user-friendly error messages
- Database migration `add_stripe_table_primary_keys.sql` adds primary key constraints to `stripe_customers`, `stripe_orders`, and `stripe_subscriptions` tables
- All changes maintain backward compatibility with existing data and subscription flows

### Benefits
- Eliminates Edge Function crashes during checkout and webhook processing
- Resolves authentication timeout issues during email confirmation flow
- Prevents duplicate subscription records and database constraint violations
- Enables proper database management and cleanup operations
- Provides clearer error messages for authentication failures
- Maintains data integrity while improving system reliability

### Fixed
- **CRITICAL**: Fixed database auto-incrementing ID constraints for Stripe tables
  - Added `GENERATED BY DEFAULT AS IDENTITY` to `id` columns in `stripe_customers`, `stripe_orders`, and `stripe_subscriptions` tables
  - This resolves "null value in column 'id'" constraint violations that were preventing webhook processing
  - Stripe webhooks can now successfully create database records without manual ID assignment
  - Users completing payment will now have their subscription data properly stored in the database

- **CRITICAL**: Fixed authStore logic to correctly populate company data for admin users
  - Changed condition from `if (isAdmin)` to `if (isAdminRole)` in the `initialize` function
  - This ensures admin users get proper company data populated in the auth store
  - Resolves issue where `company` was undefined in final auth state, causing incorrect `needsPaymentSetup` calculation
  - Admin users now correctly have `hasActiveSubscription: true` when they have completed payment setup

- **CRITICAL**: Fixed email confirmation redirect flow to properly route users to dashboard
  - Updated `AuthCallbackPage` to redirect to `/dashboard` instead of `/start-trial` after email confirmation
  - The protected route logic will then properly redirect new users to `/start-trial` if payment setup is needed
  - This prevents the login page redirect issue and ensures proper flow through the authentication system
  - Enhanced user metadata persistence by adding `registration_type` to signup data

### Fixed
- **CRITICAL**: Fixed Stripe webhook syntax errors preventing subscription processing
  - Removed duplicate `subscriptionError` variable declaration in `stripe-webhook` Edge Function
  - Fixed missing `.eq()` clause in admin record update query
  - Corrected variable reference from `session.customer` to `subscription.customer` in update operation
  - This resolves the "Identifier 'subscriptionError' has already been declared" syntax error
  - Webhooks now correctly process subscription events and populate Stripe tables
  - Users completing payment are now properly redirected to dashboard instead of being stuck on start-trial page

- **CRITICAL**: Fixed authStore logic to correctly set company data for admin users
  - Removed incorrect debug message that was appearing for admin users
  - Ensured `companyData` is properly passed to `set()` function when user is admin
  - Fixed subscription status determination logic to correctly evaluate trial and payment states
  - Updated SubscriptionPage to not automatically redirect to dashboard after payment success
  - This resolves the issue where `company` was undefined in final auth state, causing incorrect `needsPaymentSetup` calculation

### Fixed
- **CRITICAL**: Fixed Stripe webhook database constraint error preventing subscription updates
  - Added unique constraint on `customer_id` column in `stripe_subscriptions` table to enable proper upsert operations
  - Updated `stripe-webhook` Edge Function to use insert/update pattern instead of upsert with onConflict
  - This resolves the "there is no unique or exclusion constraint matching the ON CONFLICT specification" error
  - Webhooks now correctly process subscription events and update user subscription status in database
  - Users completing payment will now be properly redirected to dashboard instead of being stuck on start-trial page

- **CRITICAL**: Fixed `isAdmin` calculation in authStore to correctly identify admin users
  - Updated logic to check `adminStatus?.role === 'owner' || adminStatus?.role === 'admin'` instead of `adminStatus?.is_admin`
  - This ensures users with owner or admin roles are correctly granted administrative access
  - Resolves issue where admin users were incorrectly treated as regular members

- **Edge Function Dependencies**: Updated all Supabase Edge Functions to use latest compatible dependencies
  - Updated `@supabase/supabase-js` to v2.44.0 across all Edge Functions
  - Updated `stripe` to v16.0.0 with proper `?target=deno` parameter for better Deno compatibility
  - Replaced deprecated `serve` function with `Deno.serve` for improved performance
  - Updated Stripe API version to `2024-06-20` for latest features and bug fixes
  - This resolves `Deno.core.runMicrotasks() is not supported in this environment` errors

### Important Note
- **Database Migration Constraint**: Added critical note to avoid using `ALTER TABLE ... OWNER TO supabase_admin` or `CREATE TABLE ... OWNER TO supabase_admin` in migrations as it leads to failed migrations with error "42501: supabase_admin role memberships are reserved, only superusers can grant them"

### Important Note: Avoid this SQL Syntax
- **DO NOT USE**: `ALTER TABLE <table_name> ALTER COLUMN id SET GENERATED BY DEFAULT AS IDENTITY;`
- This syntax is problematic in PostgreSQL for existing columns and can cause `syntax error at or near "AS"` or other issues.
- For auto-incrementing primary keys, prefer `SERIAL PRIMARY KEY` or `BIGSERIAL PRIMARY KEY` when creating tables.
- If you need to convert an existing column, a more robust approach involves dropping and recreating the column, or using a full table migration strategy.
- Refer to PostgreSQL documentation and community resources for the correct way to handle identity columns on existing tables.

### Cleanup
- **File Cleanup**: Removed unused files to optimize project size and reduce memory usage
  - Removed `email-templates/confirmation.html` (email templates are now handled in Edge Functions)
  - Removed `SCHEDULED_FUNCTION_SETUP.md` (documentation moved to inline comments)
  - Removed `src/pages/auth/TestEmailConfirmation.tsx` (debug component no longer needed)
  - Removed `src/pages/marketing/LandingPage.tsx` (not used in current app flow)
  - Removed `src/pages/reports/ReportDetailPage.tsx` (placeholder component not implemented)
  - Updated App.tsx to remove references to deleted components
  - This cleanup reduces bundle size and improves build performance

### Added
- **MinIO Storage Integration**: Implemented complete MinIO storage solution replacing Supabase Storage
  - Created custom `storage-api` Supabase Edge Function for centralized file management
  - Integrated MinIO client for secure file uploads, downloads, and deletions
  - Added comprehensive user authentication and authorization for file operations
  - Implemented tier-based storage quota enforcement (Starter: 2GB, Professional: 5GB, Enterprise: 50GB)
  - Added automatic file metadata tracking in `file_metadata` table
  - Created real-time storage usage monitoring with `storage_usage` table updates
  - Added `StorageUsageCard` component to display current usage, quotas, and tier information on dashboard
  - Enhanced photo upload functionality to use MinIO instead of Supabase Storage
  - Updated PDF report generation to save files to MinIO with proper metadata tracking
  - Added file deletion capabilities with proper cleanup of both MinIO objects and database records
  - Implemented storage usage statistics with visual progress bars and upgrade prompts

### Technical Details
- New Edge Function: `supabase/functions/storage-api/index.ts` with comprehensive file management
- Updated `src/lib/inspections.ts` to use custom storage API for photo uploads
- Updated `src/lib/reports.ts` to use custom storage API for PDF report storage
- Created `src/lib/storage.ts` with unified storage operations and usage tracking
- Added `src/components/dashboard/StorageUsageCard.tsx` for real-time usage display
- Database migration: `create_storage_quotas_data.sql` to populate tier-based storage limits
- Enhanced dashboard with storage usage monitoring and tier-based upgrade prompts
- Proper error handling and authentication throughout the storage pipeline
- Support for both development mode (mock operations) and production MinIO integration

### Benefits
- Complete control over file storage with custom MinIO infrastructure
- Tier-based storage quota enforcement prevents overuse and supports subscription model
- Real-time storage usage tracking helps users monitor their consumption
- Secure file operations with proper user authentication and authorization
- Scalable storage solution that can handle large volumes of inspection photos and reports
- Enhanced user experience with clear storage limits and upgrade prompts
- Comprehensive file metadata tracking for audit trails and data management
- Cost-effective storage solution with predictable pricing and resource allocation

### Added
- **Conditional Trial Logic**: Implemented support for users who want to skip the trial period
  - Enhanced registration flow to offer "Start 14-Day Free Trial" vs "Create Account (No Trial)" options
  - Modified Stripe checkout session creation to conditionally set trial period (0 days for no-trial users, 14 days for trial users)
  - Updated webhook processing to correctly handle subscription status based on user's trial preference
  - Added `skip_trial` metadata to Stripe sessions for proper tracking and processing
  - Enhanced `StartTrialPage` to dynamically adapt messaging based on user's trial choice
  - Updated `createUserProfileAndAdmin` function to set appropriate initial subscription status

### Technical Details
- Modified `src/lib/stripe.ts` to accept `skipTrial` parameter in `createCheckoutSession` function
- Enhanced `supabase/functions/stripe-checkout/index.ts` to conditionally set `trial_period_days` based on `skip_trial` flag
- Updated `supabase/functions/stripe-webhook/index.ts` to process `skip_trial` metadata and set appropriate subscription status
- Improved `src/pages/auth/RegisterPage.tsx` with radio button selection for registration type
- Enhanced `src/pages/auth/StartTrialPage.tsx` to adapt UI and messaging based on user's trial preference
- Updated `src/store/authStore.ts` to handle registration type metadata and localStorage management

### Benefits
- Users who don't want a trial can now proceed directly to paid plans without receiving trial-related communications
- No-trial users will have `subscription_status` set to 'active' immediately, excluding them from trial reminder emails
- Improved user experience with clear choice between trial and direct subscription paths
- Maintains existing trial functionality while adding flexibility for different user preferences
- Proper Stripe integration ensures correct billing behavior for both user types

### Added
- **Email Automation System - Expiring Cards**: Implemented automated email notifications for expiring payment methods
  - Created `send-expiring-card-reminder` Supabase Edge Function for proactive card expiration notifications
  - Added `last_card_expiring_reminder_sent_at` tracking column to `stripe_subscriptions` table to prevent duplicate emails
  - Integrated with Stripe API to retrieve payment method expiration dates and customer details
  - Professional HTML email templates with responsive design and clear call-to-action buttons
  - Automated detection of cards expiring within 30-60 days with configurable reminder frequency
  - Built-in rate limiting and comprehensive error handling for reliable email delivery
  - Email tagging system for analytics and tracking through Resend.com

- **Email Automation System - Failed Payments**: Enhanced webhook handling for automatic failed payment notifications
  - Extended `stripe-webhook` Edge Function to handle `invoice.payment_failed` events
  - Automatic email notifications when subscription payments fail with detailed failure information
  - Professional HTML email templates explaining payment failure reasons and next steps
  - Direct links to customer portal for easy payment method updates
  - Comprehensive payment failure details including amount, attempt count, and suggested actions
  - Automatic admin status updates to `past_due` when payments fail
  - Integration with existing Resend.com email infrastructure for consistent delivery

### Technical Details
- New Edge Function: `supabase/functions/send-expiring-card-reminder/index.ts`
- Database migration: `add_card_expiring_reminder_tracking.sql` adds tracking column and index
- Enhanced webhook processing in `supabase/functions/stripe-webhook/index.ts`
- Stripe API integration for payment method retrieval and expiration checking
- Resend.com email delivery with proper tagging for analytics
- Comprehensive error handling and logging for both email automation systems
- External scheduler support for periodic expiring card checks
- Real-time failed payment notifications via Stripe webhooks

### Benefits
- Proactive customer engagement before payment issues occur
- Reduced involuntary churn due to expired payment methods
- Immediate notification of payment failures for quick resolution
- Professional email templates that maintain brand consistency
- Comprehensive payment failure communication with clear next steps
- Scalable architecture that can be extended for other payment-related automations
- Enhanced customer experience with timely and relevant payment communications
- Reduced support burden through automated payment issue notifications

### Changed
- **Email Service Migration**: Migrated trial reminder emails from AWS SES to Resend.com
  - Updated `send-trial-reminder` Supabase Edge Function to use Resend.com API instead of AWS SES
  - Simplified environment variable requirements (now only needs `RESEND_API_KEY` and `FROM_EMAIL`)
  - Enhanced email delivery with Resend's tagging system for better tracking
  - Updated `SCHEDULED_FUNCTION_SETUP.md` documentation to reflect Resend.com integration
  - Removed AWS SDK dependencies from Edge Function for improved performance
  - Maintained all existing functionality while improving reliability and ease of setup

### Technical Details
- Modified `supabase/functions/send-trial-reminder/index.ts` to use Resend API endpoints
- Updated `supabase/functions/send-trial-reminder/deno.json` to remove AWS SDK imports
- Replaced AWS SES client with native fetch API calls to Resend.com
- Added email tagging for better analytics and tracking
- Improved error handling and logging for Resend API responses
- Maintained backward compatibility with existing database schema and scheduler setup

### Fixed
- **Database Relationship Error**: Fixed relationship query error in `send-trial-reminder` function
  - Corrected the join between `admin` and `profiles` tables by removing explicit foreign key reference
  - Changed from `profiles!admin_owner_id_fkey` to `profiles` to allow PostgREST to infer the correct relationship
  - This resolves the "Could not find a relationship between 'admin' and 'profiles' in the schema cache" error
  - Function now correctly retrieves user email and full name for trial reminder emails

### Benefits
- Simplified setup process (no AWS account or IAM configuration required)
- Better email deliverability with Resend's infrastructure
- Enhanced email analytics and tracking capabilities
- Reduced function cold start times by removing heavy AWS SDK dependencies
- More developer-friendly API and documentation
- Cost-effective email delivery for transactional emails

### Added
- **Storage Infrastructure**: Created Supabase storage buckets for file management
  - `inspection-photos` bucket for storing inspection images (5MB limit, public access)
  - `inspection-reports` bucket for storing PDF reports (50MB limit, authenticated access)
  - Implemented Row Level Security policies for organization-based file access
  - Support for JPEG, PNG, WebP images and PDF documents
  - Proper file organization with inspection-based folder structure

### Fixed
- **CRITICAL**: Fixed email confirmation redirect URLs to consistently use production URL (app.scopostay.com)
- Updated signUp and resendConfirmationEmail functions to use getSiteUrl() instead of window.location.origin
- This ensures email confirmation links always point to the correct production domain regardless of environment
- Resolves issues where email confirmation links might point to localhost during development

### Fixed
- **CRITICAL**: Fixed email confirmation redirect flow to properly route new users to start-trial page
- Updated email confirmation URLs to use current site origin instead of hardcoded production URL
- Enhanced AuthCallbackPage navigation with replace: true to prevent back button issues
- Improved logging in authStore to better track subscription state determination
- This ensures new users who confirm their email are correctly redirected to /start-trial instead of login page

### Fixed
- **CRITICAL**: Fixed trial user redirect logic to properly route new users to start-trial page
- Trial users with NULL customer_id (haven't completed payment setup) now correctly have needsPaymentSetup=true
- This ensures new users are redirected to /start-trial instead of accessing dashboard prematurely
- Enhanced logging to track subscription state determination for better debugging
- Fixed edge case where trialing users without payment setup were incorrectly granted dashboard access

### Fixed
- **CRITICAL**: Fixed new user redirect flow to properly route to start-trial page after email confirmation
- Removed dev mode override that was incorrectly setting needsPaymentSetup to false for all users
- New users who confirm their email will now be correctly redirected to /start-trial instead of dashboard
- This ensures proper subscription setup flow for all new signups regardless of environment

### Added
- **Email Automation System**: Implemented scheduled trial expiration reminder emails using Amazon SES
  - Created `send-trial-reminder` Supabase Edge Function for automated email delivery
  - Added `trial_reminder_7day_sent` tracking column to `admin` table to prevent duplicate emails
  - Integrated Amazon SES SDK for reliable transactional email delivery
  - Implemented comprehensive email template with HTML and text versions
  - Added external scheduler support (cron-job.org, GitHub Actions, Vercel Cron)
  - Built-in error handling, retry logic, and comprehensive logging
  - Supports both development and production environments with proper email verification

### Technical Details
- New Edge Function: `supabase/functions/send-trial-reminder/index.ts`
- Database migration: `add_trial_reminder_tracking.sql` adds tracking column and index
- AWS SES integration with proper IAM permissions and security best practices
- Scheduled execution via external cron services (daily at 9 AM UTC)
- Comprehensive setup documentation in `SCHEDULED_FUNCTION_SETUP.md`
- Email templates include company branding and clear call-to-action buttons
- Function processes users whose trial ends in exactly 7 days and haven't received reminder yet
- Automatic database flag updates to prevent duplicate email sends
- Built-in rate limiting and delays to respect SES sending limits

### Benefits
- Proactive customer engagement 7 days before trial expiration
- Reduces involuntary churn by giving users advance notice
- Professional HTML email templates with responsive design
- Scalable architecture that can be extended for other email automations
- Comprehensive error handling and monitoring capabilities
- Zero impact on existing subscription functionality

### Added
- **Email Automation System**: Implemented scheduled trial expiration reminder emails using Amazon SES
  - Created `send-trial-reminder` Supabase Edge Function for automated email delivery
  - Added `trial_reminder_7day_sent` tracking column to `admin` table to prevent duplicate emails
  - Integrated Amazon SES SDK for reliable transactional email delivery
  - Implemented comprehensive email template with HTML and text versions
  - Added external scheduler support (cron-job.org, GitHub Actions, Vercel Cron)
  - Built-in error handling, retry logic, and comprehensive logging
  - Supports both development and production environments with proper email verification

### Technical Details
- New Edge Function: `supabase/functions/send-trial-reminder/index.ts`
- Database migration: `add_trial_reminder_tracking.sql` adds tracking column and index
- AWS SES integration with proper IAM permissions and security best practices
- Scheduled execution via external cron services (daily at 9 AM UTC)
- Comprehensive setup documentation in `SCHEDULED_FUNCTION_SETUP.md`
- Email templates include company branding and clear call-to-action buttons
- Function processes users whose trial ends in exactly 7 days and haven't received reminder yet
- Automatic database flag updates to prevent duplicate email sends
- Built-in rate limiting and delays to respect SES sending limits

### Benefits
- Proactive customer engagement 7 days before trial expiration
- Reduces involuntary churn by giving users advance notice
- Professional HTML email templates with responsive design
- Scalable architecture that can be extended for other email automations
- Comprehensive error handling and monitoring capabilities
- Zero impact on existing subscription functionality

### Added
- **Stripe Subscription Trial**: Implemented proper Stripe subscription model with 14-day free trial
  - Updated checkout flow to create subscriptions instead of one-time payments
  - Added `trial_period_days: 14` to checkout session creation
  - Enhanced webhook handling for subscription lifecycle events
  - Added support for `customer.subscription.trial_will_end`, `customer.subscription.created`, `customer.subscription.deleted`, and `invoice.payment_failed` webhooks
  - Updated frontend UI to clearly display trial status and benefits
  - Improved subscription status logic in authStore to handle trial periods correctly
  - Added `trialDays` property to Stripe product configuration
  - Enhanced trial status display in StartTrialPage and SubscriptionPage

### Technical Details
- Modified `supabase/functions/stripe-checkout/index.ts` to create subscription checkout sessions with trial periods
- Enhanced `supabase/functions/stripe-webhook/index.ts` with comprehensive subscription event handling
- Updated `src/store/authStore.ts` subscription status determination logic for trial periods
- Improved UI components to better communicate trial benefits and status
- Added proper handling for subscription status transitions (trialing → active → past_due → canceled)

### Benefits
- Users can now start using the platform immediately with a true 14-day free trial
- Payment method is authorized (not charged) during signup for seamless trial-to-paid conversion
- Automatic billing occurs after trial expires unless cancelled
- Better user experience with clear trial status communication
- Robust webhook handling ensures accurate subscription state synchronization

### Fixed
- **CRITICAL**: Fixed hasActiveSubscription logic for trialing users with payment setup
- Trial users who have provided payment details (customer_id present) now correctly have hasActiveSubscription set to true
- This resolves authentication flow issues where users with active trials and payment setup were incorrectly blocked from dashboard access
- Prevents infinite redirect loops and ensures proper access control for trial users who have completed payment setup

### Added
- **Database Schema**: Added `reports` table to store inspection report metadata
  - Table includes `id`, `inspection_id`, `report_url`, `report_type`, `generated_at`, `created_at`, `updated_at` columns
  - Added proper indexes for `inspection_id` and `generated_at` for efficient querying
  - Enabled Row Level Security (RLS) with policy for team member access
  - Added `updated_at` trigger for automatic timestamp updates
  - This resolves the 400 error when accessing the Reports page and enables PDF report storage/retrieval

### Fixed
- **CRITICAL**: Fixed hasActiveSubscription logic to correctly return false for trial users without customer_id
- Trial users without payment setup (customer_id is null) now have hasActiveSubscription set to false
- Added needsPaymentSetup property to all set() calls in authStore to ensure proper redirection logic
- Enhanced console logging to track needsPaymentSetup calculation and inclusion in store state
- Removed handleAuthError call from initialize() catch block to prevent infinite redirect loops
- This ensures new users are properly redirected to /start-trial page instead of accessing dashboard

### Fixed
- Fixed hasActiveSubscription logic to require customer_id for trial users
- Trial users without payment setup (customer_id is null) now correctly have hasActiveSubscription set to false
- This ensures new users are properly redirected to /start-trial page instead of accessing dashboard
- Added needsPaymentSetup property to authStore set() call to enable proper redirection logic
- Moved /start-trial route outside of AuthLayout to prevent authenticated user redirect issues
- Enhanced debug logging to track subscription status determination and route guard behavior

### Fixed
### Fixed
- Fixed redirect logic for trialing users with NULL customer_id to properly route to StartTrialPage
- This ensures new users complete the payment setup flow before accessing the main application

### Fixed
- Fixed StartTrialPage redirect logic to prevent trial users from being immediately redirected to dashboard
- Modified redirect condition in StartTrialPage to only redirect users with active paid subscriptions (`subscription_status === 'active'`)
- Trial users (`subscription_status === 'trialing'`) now remain on StartTrialPage to complete plan selection
- This resolves the regression where new users were bypassing the plan selection flow after email confirmation

### Fixed
- Fixed authentication flow to properly redirect new users to start-trial page after email confirmation
- Simplified subscription status logic in authStore to correctly identify new users vs. users requiring payment
- Removed overly restrictive `requiresPayment` logic that was blocking new users from accessing start-trial page
- AuthCallbackPage now consistently redirects to `/start-trial` after successful email confirmation
- New users (with no admin data or `subscription_status` of `not_started`) are no longer incorrectly flagged as requiring payment

### Fixed
- Fixed email confirmation redirect URL to properly route to `/auth/callback` instead of root path
- Ensured both `signUp` and `resendConfirmationEmail` functions use the correct `emailRedirectTo` URL
- This resolves the issue where clicking email confirmation links would redirect to the landing page instead of the AuthCallbackPage

### Fixed
- Fixed AuthCallbackPage error handling to prevent premature session clearing during PKCE flow
- Improved error handling for `flow_state_expired` errors during email confirmation
- Prevented `supabase.auth.signOut()` from being called when `getSession()` fails during callback, which was clearing necessary PKCE state from localStorage
- Enhanced AuthCallbackPage with comprehensive debugging and better PKCE flow handling
- Added explicit code exchange attempt using `exchangeCodeForSession()` method
- Improved error messages for different types of authentication failures
- Added debug information display in development mode

### Technical Details
- Modified `src/pages/auth/AuthCallbackPage.tsx` to handle session errors more gracefully
- Added better error logging to distinguish between different types of authentication failures
- Improved retry mechanism for authentication callback timeouts

## [Previous Versions]
- Initial project setup and core functionality implementation